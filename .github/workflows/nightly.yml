name: Nightly Build

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_matrix:
        description: 'Run full test matrix'
        type: boolean
        default: true
      extended_tests:
        description: 'Run extended test scenarios'
        type: boolean
        default: true

permissions:
  contents: read
  actions: read
  issues: write

env:
  MIX_ENV: test
  SKIP_TERMBOX2_TESTS: true
  TMPDIR: /tmp

jobs:
  test-matrix:
    name: Test Matrix (${{ matrix.elixir }}/${{ matrix.otp }}/${{ matrix.os }})
    if: github.event.inputs.test_matrix != 'false'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        elixir: ["1.17.3", "1.18.3", "1.19.0"]
        otp: ["27.2", "28.2"]
        exclude:
          # Exclude incompatible combinations
          - elixir: "1.17.3"
            otp: "28.2"
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Setup OS dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf m4 libncurses5-dev \
            libssl-dev libgl1-mesa-dev libglu1-mesa-dev libpng-dev openssl \
            postgresql postgresql-contrib
          
          sudo service postgresql start
          sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres';"
          sudo -u postgres psql -c "CREATE DATABASE raxol_test;"
      
      - name: Setup OS dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install openssl@1.1 postgresql@14
          echo "LDFLAGS=-L$(brew --prefix openssl@1.1)/lib" >> $GITHUB_ENV
          echo "CFLAGS=-I$(brew --prefix openssl@1.1)/include" >> $GITHUB_ENV
          
          brew services start postgresql@14 || true
          sleep 5
          createuser -s postgres || true
          psql -U postgres -c "ALTER USER postgres WITH PASSWORD 'postgres';" postgres || true
          createdb -U postgres raxol_test || true
      
      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
            priv/plts
          key: ${{ runner.os }}-mix-${{ matrix.otp }}-${{ matrix.elixir }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ matrix.otp }}-${{ matrix.elixir }}-
      
      - name: Install dependencies
        run: |
          # Uninstall and reinstall Hex to ensure OTP compatibility
          mix archive.uninstall hex --force || true
          mix local.hex --force
          mix local.rebar --force
          mix deps.get
          mix deps.compile
      
      - name: Run full test suite
        run: |
          mix test --exclude slow --exclude integration --exclude docker
        env:
          POSTGRES_HOST: localhost
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: raxol_test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@89ef406dd8d7e03cfd12d9e0a4a378f454709029 # v4.4.3
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.elixir }}-${{ matrix.otp }}
          path: |
            _build/test/lib/*/test-results.xml
          retention-days: 30
          if-no-files-found: warn

  extended-scenarios:
    name: Extended Test Scenarios
    if: github.event.inputs.extended_tests != 'false'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19.0"
          otp-version: "28.2"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-extended-${{ hashFiles('**/mix.lock') }}

      - name: Install dependencies
        run: |
          # Uninstall and reinstall Hex to ensure OTP compatibility
          mix archive.uninstall hex --force || true
          mix local.hex --force
          mix local.rebar --force
          mix deps.get
          mix deps.compile

      - name: Run stress tests
        run: |
          mix test --only stress || true

      - name: Run edge case tests
        run: |
          mix test --only edge_cases || true

      - name: Run property-based tests (extended)
        run: |
          mix test --only property --timeout 300000 || true

      - name: Generate extended test report
        run: |
          echo "## Extended Test Scenarios Report" > extended-report.md
          echo "" >> extended-report.md
          echo "Date: $(date)" >> extended-report.md
          echo "" >> extended-report.md
          echo "Extended test scenarios completed." >> extended-report.md

          cat extended-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload extended test results
        if: always()
        uses: actions/upload-artifact@89ef406dd8d7e03cfd12d9e0a4a378f454709029 # v4.4.3
        with:
          name: extended-test-results-$(date +%Y%m%d)
          path: |
            _build/test/lib/*/test-results.xml
            extended-report.md
          retention-days: 90
          if-no-files-found: warn

  dialyzer-full:
    name: Full Dialyzer Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19.0"
          otp-version: "28.2"

      - name: Cache dependencies and PLTs
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
            priv/plts
          key: plt-${{ runner.os }}-28.2-1.19.0-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            plt-${{ runner.os }}-28.2-1.19.0-
      
      - name: Install dependencies
        run: |
          # Uninstall and reinstall Hex to ensure OTP compatibility
          mix archive.uninstall hex --force || true
          mix local.hex --force
          mix local.rebar --force
          mix deps.get
          mix deps.compile
      
      - name: Build PLTs
        run: |
          mix dialyzer --plt
        timeout-minutes: 20
        continue-on-error: true

      - name: Run Dialyzer
        run: |
          mix dialyzer --format github
        continue-on-error: true

  integration-tests:
    name: Extended Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: raxol_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v5

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19.0"
          otp-version: "28.2"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-integration-${{ hashFiles('**/mix.lock') }}

      - name: Install dependencies
        run: |
          # Uninstall and reinstall Hex to ensure OTP compatibility
          mix archive.uninstall hex --force || true
          mix local.hex --force
          mix local.rebar --force
          mix deps.get
          mix deps.compile

      - name: Run integration tests
        run: |
          mix test --only integration --only slow || echo "No integration/slow tests found or tests failed"
        env:
          POSTGRES_HOST: localhost
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: raxol_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379

  report:
    name: Nightly Report
    needs: [test-matrix, extended-scenarios, dialyzer-full, integration-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# ðŸŒ™ Nightly Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Matrix | ${{ needs.test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Extended Scenarios | ${{ needs.extended-scenarios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dialyzer | ${{ needs.dialyzer-full.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Create issue on failure
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v8
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸŒ™ Nightly build failure - ${date}`,
              body: `The nightly build failed. Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['bug', 'nightly-build']
            });